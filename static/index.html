<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Go Todo Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .server-info { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .active-badge { font-weight: bold; }
        .todo-item { cursor: pointer; transition: 0.2s; }
        .todo-item:hover { background-color: #f1f1f1; }
        .completed { text-decoration: line-through; color: gray; }
    </style>
</head>
<body>
    <div class="container" style="max-width: 600px;">
        <div class="server-info text-center">
            <h2>ğŸš€ Go Todo Service</h2>
            <p id="server-status">ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...</p>
        </div>

        <div class="input-group mb-3">
            <input type="text" id="new-task" class="form-control" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ëŸ°ë‹ë¨¸ì‹  ë›°ê¸°)">
            <button class="btn btn-primary" onclick="addTodo()">ì¶”ê°€</button>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ“‹ í•  ì¼ ëª©ë¡</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="fetchTodos()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <ul class="list-group list-group-flush" id="todo-list">
                </ul>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost"; // Nginx ì£¼ì†Œ

        // 1. ì¡°íšŒ (GET)
        async function fetchTodos() {
            try {
                const response = await fetch(`${API_URL}/todos`);
                const result = await response.json();
                
                // ì„œë²„ ì´ë¦„ í‘œì‹œ
                const serverName = result.message || "Unknown";
                const badgeColor = serverName.includes("server-1") ? "success" : "warning"; // 1ë²ˆì€ ì´ˆë¡, 2ë²ˆì€ ë…¸ë‘
                
                document.getElementById('server-status').innerHTML = 
                    `í˜„ì¬ ì‘ë‹µ ì¤‘ì¸ ì„œë²„: <span class="badge bg-${badgeColor} active-badge">${serverName}</span>`;

                renderList(result.data);
            } catch (error) {
                console.error(error);
                document.getElementById('server-status').innerText = "ğŸ”´ ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
            }
        }

        // 2. ì¶”ê°€ (POST)
        async function addTodo() {
            const input = document.getElementById('new-task');
            const task = input.value.trim();
            if (!task) return;

            await fetch(`${API_URL}/todos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task: task, completed: false })
            });
            input.value = "";
            fetchTodos(); // ëª©ë¡ ê°±ì‹ 
        }

        // 3. ì™„ë£Œ ì²˜ë¦¬ í† ê¸€ (PATCH)
        async function toggleTodo(id, currentTask, currentStatus) {
            await fetch(`${API_URL}/todos/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task: currentTask, completed: !currentStatus })
            });
            fetchTodos();
        }

        // 4. ì‚­ì œ (DELETE)
        async function deleteTodo(event, id) {
            event.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (ì™„ë£Œ ì²˜ë¦¬ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ)
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            await fetch(`${API_URL}/todos/${id}`, { method: 'DELETE' });
            fetchTodos();
        }

        // ëª©ë¡ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function renderList(todos) {
            const list = document.getElementById('todo-list');
            list.innerHTML = "";
            if (!todos || todos.length === 0) {
                list.innerHTML = "<li class='list-group-item text-center text-muted'>í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€í•´ë³´ì„¸ìš”!</li>";
                return;
            }

            todos.forEach(todo => {
                const item = document.createElement('li');
                item.className = "list-group-item todo-item d-flex justify-content-between align-items-center";
                item.onclick = () => toggleTodo(todo.id, todo.task, todo.completed); // í´ë¦­ ì‹œ ì™„ë£Œ í† ê¸€
                
                item.innerHTML = `
                    <span class="${todo.done ? 'completed' : ''}">
                        ${todo.done ? 'âœ…' : 'â¬œ'} ${todo.task}
                    </span>
                    <button class="btn btn-danger btn-sm" onclick="deleteTodo(event, ${todo.id})">ì‚­ì œ</button>
                `;
                list.appendChild(item);
            });
        }

        // ì‹œì‘ ì‹œ ë¡œë”©
        fetchTodos();
    </script>
</body>
</html>